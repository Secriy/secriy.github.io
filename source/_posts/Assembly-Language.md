---
title: Assembly Language
date: 2021-08-15 11:22:26
categories: 学习笔记
tags:
  - 汇编
---

{% noteblock quote cyan %}

对汇编语言的学习总结。

{% endnoteblock %}

<!-- more -->

## 基础知识

### 机器语言

机器语言是机器指令的集合，以二进制表示，每一种 CPU 都有自己的机器指令集，机器指令指定 CPU 进行特定的任务。

### 汇编语言

机器指令全部由二进制编写，人类难以编写和调试，因此汇编语言出现了。汇编程序通过编译器生成对应的机器码，由 CPU 进行执行。例如汇编指令`MOV AX, BX`编译生成的机器码为`1000100111011000`（8086CPU）。

汇编语言由以下三个部分组成：

1. 汇编指令，如`MOV`，是机器指令的助记符，和机器指令一一对应；
2. 伪指令，没有对应的机器码，编译器对其进行处理，计算机并不执行；
3. 其他符号，如`+ - * /`等，由编译器识别，没有对应的机器码。

### 存储器

向 CPU 提供的程序指令以及数据都由存储器保存，需要时调入 CPU 执行，这里的存储器即内存。

> 指令和数据在内存或磁盘上并没有差别，都是一串二进制信息，同样的一串二进制数位如`1000100111011000`可以被看作是指令`MOV AX, BX`也可以被看作是数据`89D8H`。CPU 会按照特定机制把信息看作是指令或是数据，比如在不同的 CPU 指令周期把信息认作不同的类型。

#### 存储单元

存储器被抽象为线性的若干个单元，从 0 开始编号，如存储器有 128 个存储单元，编号从 0~127。每个存储单元大小为 8bit 即 1byte。

#### CPU 读写存储器

CPU 需要通过以下三种信息来进行存储器上的数据读写：

1. 存储单元的地址（地址信息）；
2. 芯片或器件的选择，读或写的命令（控制信息）；
3. 读或写的数据（数据信息）。

步骤如下：

1. CPU 通过**地址线**将地址信息（如指定存储器 3 号单元）发出；
2. CPU 通过**控制线**发出内存读命令，并选中需要用到的存储器；
3. 存储器将 3 好单元内的数据通过**数据线**送入 CPU。

### 三类总线

#### 地址总线

一根地址线可以表示 0、1 两个状态，因此可以寻 0、1 两个地址，10 根地址线可以寻址$2^{10}$即 1024 个地址（0~1023）。

地址总线的宽度决定了 CPU 的寻址空间大小。

#### 数据总线

单根数据线可以一次传送 1bit 的信息，8 根数据线可以一次传送 8bit 的数据。8086CPU 有 16 根地址线，可以一次传送 16 位数据，即 2byte。读超过数据总线宽度的数据时需要多次读取。

数据总线的宽度决定了 CPU 单次能传输的数据量。

#### 控制总线

单根控制线提供了对外部部件的某一控制信息，如“读信号输出”控制线负责向外界传递读信号。

控制总线的宽度决定了 CPU 对其他器件的控制能力。

### 内存地址空间

不同的设备提供了不同的硬件适配器（即接口卡），如网卡的网络适配器、显卡的显示控制器等，计算机要通过给硬件适配器传送命令来完成一系列操作。通常硬件适配器上会有一个存储空间来暂存数据，如显卡的显存用来临时存放将要显示的数据。

CPU 将分布在不同硬件上的各类存储器看作是一个存储器的一部分，也就是说在 CPU 眼里这些存储器组成了一个线性的存储器（内存地址空间）。比如主存占用内存地址空间的 0\~1023 地址，显存占用 1024\~1151 地址。想对显存读写的时候 CPU 可以直接指定 1024\~1151 地址区间。

地址空间的大小取决于 CPU 的寻址能力，即地址总线的宽度。

## 寄存器

CPU 从内存中读取指令和数据然后对其进行处理，因此 CPU 内部还需要暂存这些指令和数据，由寄存器完成这项任务。

CPU 的组成：

- 运算器，负责进行运算；
- 寄存器，负责存储信息；
- 控制器，控制各种器件工作；
- 内部总线，负责连接各部件，在其中传送数据。

8086CPU 中的寄存器（14 个）：AX、BX、CX、DX、SI、DI、SP、BP、IP、CS、SS、DS、ES、PSW。

### 通用寄存器

上述 8086CPU 的寄存器中，AX、BX、CX、DX 为通用寄存器，用于存放一般性的数据。其存储大小皆为 16bit。

8086CPU 为了兼容为上代 8 位寄存器的 CPU 编写的程序，每个通用寄存器可以分为两个 8bit 寄存器使用：

- AX 可以分为 AH 和 AL
- BX 可以分为 BH 和 BL
- CX 可以分为 CH 和 CL
- DX 可以分为 DH 和 DL

### 指令示例

|   汇编指令    |                   操作                   |
| :-----------: | :--------------------------------------: |
| MOV AX, 4E20H |          将 4E20H 送入寄存器 AX          |
|  MOV AX, BX   |     将寄存器 BX 的内容送入寄存器 AX      |
| ADD AX, 1406H |          将 AX 的内容加上 1406H          |
|  ADD AX, BX   | 将 AX 的内容加上 BX 的内容，存储在 AX 中 |

指令的两个数据对象必须位数一致。16 位寄存器只能存 16 位数据，如操作 ADD 指令后超出 16 位，则只保留低 16 位在寄存器中。直接操作 AL 溢出后并不能将溢出值放入 AH 中，和 16 位一样只保留低 8 位。

### 物理地址

对于 16 位 CPU（如 8086）：

- 运算器一次最多处理 16 位数据；
- 寄存器最大宽度为 16 位；
- 寄存器与运算器之间的通路为 16 位。

8086CPU 有 20 根地址总线，内存单元物理地址需要用 20bit 存储，但它是 16 位 CPU，因此需要两个寄存器来保存一个地址。

第一个寄存器提供段地址，第二个寄存器提供偏移地址，最终通过物理地址=段地址\*16+偏移地址来计算出实际的物理地址，如：

- 段地址 1000H，偏移地址 124AH，得出物理地址 1124AH；

- 段地址 1230H，偏移地址 00C8H，得出物理地址 123C8H。

对段地址（16 进制表示）乘以 16 实质是左移一位。1000H 左移一位即 10000H。

不同的段地址和偏移地址能够得到相同的物理地址。

段地址实际上是 CPU 对内存的抽象划分，内存本身并没有段的概念，由于偏移地址由 16 位存储，即可以表示 64KB 大小的地址空间，因此一个段的最大容量为 64KB。也就是说给定一个段地址，无法寻址到从它开始 64KB 以外的内存单元。

### 段寄存器

8086CPU 有四个段寄存器：CS、DS、SS、ES。

这些段寄存器用来存放段地址。

### CS 和 IP

IP 是一个指令指针寄存器，即用于存放内存物理地址的偏移，通过 CS 和 IP 中的内容就可以生成一个物理地址。

如 CS（2000H），IP（0000H），由地址加法器计算出物理地址为 20000H，通过地址总线寻址，由数据总线将其中的指令和数据调入 CPU 执行。这期间 IP 中的偏移位会增加，指向下一个内存中的指令地址。8086CPU 刚启动时 CS 和 IP 的默认值分别为 FFFFH 和 0000H，即初始从 FFFF0H 取指执行。CPU 通过 CS:IP 指定的物理地址来确定一个内存中的信息是否是指令，CS:IP 指向的内存单元内容被 CPU 看作是指令。

要想修改 CS 和 IP 的内容无法通过 MOV 指令完成，可以通过 JMP 指令（JMP 段地址:偏移地址）来操作：

```assembly
JMP 2AE3:3
JMP 3:0B16
```

执行后 CS 和 IP 的值会被修改为指定的值。

### 代码段

通过段的抽象，可以将指令都放在指定的一些内存连续的段中，被称为代码段，这种方式能够让指令聚集在连续的内存单元中，方便管理和隔离。

## DEBUG 实践

可以通过 DOSBox 来模拟 DOS 环境，在其下进行实验。

### 配置环境

1. 下载安装[DOSBox](https://www.dosbox.com/download.php?main=1)；
2. 下载[DEBUG.zip](Assembly-Language\DEBUG.zip) 解压到固定目录，如 DOSBox 安装目录下；
3. 打开 DOSBox，执行`mount x path_to\DOSBox`，将 DOSBox 目录挂载到`x`盘符；
4. 执行`X:`，切换到`x`盘符下；
5. 执行`cd path_to`来切换到 DEBUG.zip 的解压路径，如`cd DEBUG`。

![image-20210815130257882](Assembly-Language/image-20210815130257882.png)

### DEBUG 常用命令

- R，查看、改变 CPU 寄存器中的内容；
- D，查看内存中的内容；
- E，改写内存中的内容；
- U，将内存中的机器指令翻译成汇编；
- T，执行一条机器指令；
- A，以汇编格式在内存中写入一条机器指令

### 操作
